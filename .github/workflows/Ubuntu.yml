name: Headless Go + Tailscale

on:
  workflow_dispatch:

jobs:
  setup:
    runs-on: ubuntu-22.04
    container:
      image: debian:12
      options: --user root

    env:
      USERNAME: "dolvin"
      PASSWORD: "whatsapp2"
      TALESCALE_AUTH_KEY: ${{ secrets.TALESCALE_AUTH_KEY }}

    timeout-minutes: 360

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Prepare System
        run: |
          apt update -y
          apt upgrade
          apt install -y git wget curl nano sudo

      - name: Create User (optional)
        run: |
          useradd -m -s /bin/bash "$USERNAME" || true
          echo "$USERNAME:$PASSWORD" | chpasswd
          usermod -aG sudo "$USERNAME" || true

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
      - name: Start Tailscale  
        run: |
          tailscaled & sleep 3
          tailscale up --authkey="${{ env.TALESCALE_AUTH_KEY }}" --hostname=runner-${{ github.run_id }}  
          tailscale ip -4  

      - name: Keep Alive
        run: |
          echo "Runner active. Stop workflow to exit."
          while true; do sleep 300; done
