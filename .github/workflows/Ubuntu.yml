name: Go + Snap + Tailscale (Auto-Loop 90 Days)

on:
  workflow_dispatch:

jobs:
  headless-runner:
    runs-on: ubuntu-latest
    timeout-minutes: 350  # auto loop before GH kills at ~360

    env:
      USERNAME: "dolvin"
      PASSWORD: "whatsapp2"
      TSKEY: ${{ secrets.TALESCALE_AUTH_KEY }}
      GH_PAT: ${{ secrets.GH_PAT }}

    steps:
      - uses: actions/checkout@v4

      - name: Prep System
        run: |
          sudo apt-get update -y
          sudo apt-get upgrade -y

      - name: Create User
        run: |
          U="${{ env.USERNAME }}"
          P="${{ env.PASSWORD }}"
          sudo useradd -m -s /bin/bash "$U" || true
          echo "$U:$P" | sudo chpasswd
          sudo usermod -aG sudo "$U"
          echo "[+] User created: $U"

      - name: Install Snapd
        run: |
          sudo apt-get install -y snapd
          sudo systemctl enable --now snapd
          snap version

      - name: Install Latest Go
        run: |
          LATEST=$(curl -fsSL https://go.dev/VERSION?m=text)
          wget -qO /tmp/go.tgz "https://go.dev/dl/${LATEST}.linux-amd64.tar.gz"
          sudo rm -rf /usr/local/go
          sudo tar -C /usr/local -xzf /tmp/go.tgz
          echo "export PATH=/usr/local/go/bin:\$PATH" | sudo tee /etc/profile.d/go.sh
          /usr/local/go/bin/go version

      - name: Install & Start Tailscale
        run: |
          if [ -z "$TSKEY" ]; then
            echo "‚ùå ERROR: Secret TALESCALE_AUTH_KEY belum diset."
            exit 1
          fi
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscaled & sleep 3
          sudo tailscale up --authkey "$TSKEY" --hostname=headless-${{ github.run_id }}
          echo "[+] Tailscale IP:"
          tailscale ip -4

      - name: Keep Alive (prevent idle)
        run: |
          echo "Runner active. Use Ctrl+C on your client to exit."
          while true; do
            echo "[üü¢] $(date)"
            sleep 60
          done &

      - name: Auto-Restart Workflow Before Timeout
        if: always()
        run: |
          echo "[‚ôªÔ∏è] Scheduling next run..."
          curl -X POST \
            -H "Authorization: token $GH_PAT" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/${{ github.workflow }}/dispatches \
            -d '{"ref":"main"}'
          echo "[‚úÖ] Next run triggered."
