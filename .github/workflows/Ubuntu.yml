name: GUI + Go + Snap (minimal)

on:
  workflow_dispatch:

jobs:
  gui-go-snap:
    runs-on: ubuntu-latest
    timeout-minutes: 180

    env:
      USERNAME: "dolvin"
      PASSWORD: "whatsapp2"   # WARNING: plaintext in workflow (unsafe for public repos)

    steps:
      - name: Checkout (no tools, just housekeeping)
        uses: actions/checkout@v4

      - name: Show runner info
        run: |
          echo "Runner info: $(uname -a)"
          lsb_release -a || true
          free -h
          df -h /

      - name: Prepare apt (noninteractive)
        run: |
          export DEBIAN_FRONTEND=noninteractive
          sudo apt-get update -y
          sudo apt-get upgrade -y

      - name: Create user dolvin
        run: |
          U="${{ env.USERNAME }}"
          P="${{ env.PASSWORD }}"
          if ! id -u "$U" >/dev/null 2>&1; then
            sudo useradd -m -s /bin/bash "$U"
          fi
          echo "$U:$P" | sudo chpasswd
          sudo usermod -aG sudo "$U" || true
          sudo mkdir -p /home/$U/.ssh
          sudo chown $U:$U /home/$U/.ssh
          sudo chmod 700 /home/$U/.ssh
          echo "User $U ready (password = $P)"

      - name: Install desktop environment (XFCE) + x2go + xrdp + snapd
        run: |
          export DEBIAN_FRONTEND=noninteractive
          # Lightweight desktop & remote servers
          sudo apt-get install -y --no-install-recommends xfce4 xfce4-terminal xfce4-goodies dbus-x11 xfconf
          sudo apt-get install -y x2goserver x2goserver-xsession
          sudo apt-get install -y xrdp
          # Snapd for snaps
          sudo apt-get install -y snapd
          sudo systemctl enable --now snapd
          # ensure xfce session for the user
          echo "xfce4-session" | sudo tee /home/${{ env.USERNAME }}/.xsession
          sudo chown ${{ env.USERNAME }}:${{ env.USERNAME }} /home/${{ env.USERNAME }}/.xsession
          # make xrdp use xfce session
          sudo sed -i.bak 's|exec /bin/sh /etc/X11/Xsession|#exec /bin/sh /etc/X11/Xsession|' /etc/xrdp/startwm.sh || true
          echo "exec xfce4-session" | sudo tee -a /etc/xrdp/startwm.sh
          sudo systemctl enable --now xrdp x2goserver || true
          sudo systemctl restart dbus || true

      - name: Install latest Go
        run: |
          if command -v go >/dev/null 2>&1; then
            echo "Go already installed: $(go version)"
          else
            LATEST=$(curl -fsS https://go.dev/VERSION?m=text)
            echo "Installing ${LATEST}"
            wget -qO /tmp/go.tgz "https://go.dev/dl/${LATEST}.linux-amd64.tar.gz"
            sudo rm -rf /usr/local/go
            sudo tar -C /usr/local -xzf /tmp/go.tgz
            rm -f /tmp/go.tgz
            echo "export PATH=\$PATH:/usr/local/go/bin" | sudo tee /etc/profile.d/go_path.sh
            sudo chmod +x /usr/local/go/bin/go || true
          fi
          # quick verify
          /usr/local/go/bin/go version || go version || true

      - name: Final checks (GUI + Go + snap)
        run: |
          echo "== quick checks =="
          echo "User:"
          id ${{ env.USERNAME }} || true
          echo "XFCE session file:"
          ls -l /home/${{ env.USERNAME }}/.xsession || true
          echo "xrdp status:"
          sudo systemctl status xrdp --no-pager || true
          echo "x2go server status:"
          sudo systemctl status x2goserver --no-pager || true
          echo "snapd version:"
          snap version || true
          echo "go version:"
          /usr/local/go/bin/go version || go version || true

      - name: Keep runner alive (manual cancel to stop)
        run: |
          echo "Runner active. Cancel the workflow in Actions UI to terminate."
          while true; do
            echo "alive: $(date)"; sleep 300
          done
