name: CI/CD Dengan Akses Tailscale

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  # Anda juga bisa memicu ini secara manual dari GitHub UI
  workflow_dispatch:

jobs:
  ci-with-tailscale:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Kode
        uses: actions/checkout@v4

      # =========================================================
      # 1. KONEKSI KE JARINGAN AMAN (TAILSCALE - OPSI B)
      # =========================================================
      - name: Hubungkan ke Jaringan Tailscale (Menggunakan Auth Key)
        uses: tailscale/github-action@v2
        with:
          # Menggunakan Secret Key dari GitHub Secrets (Opsi B)
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }} 
          # Disarankan untuk menggunakan tag ACL untuk kontrol akses
          tags: tag:ci
          
      - name: Tampilkan Status Tailscale (Verifikasi)
        run: tailscale status

      # =========================================================
      # 2. FASE PENGEMBANGAN/DEPLOYMENT
      # =========================================================
      
      - name: Jalankan Perintah yang Membutuhkan Akses ke Jaringan Pribadi
        # Contoh: SSH ke server pribadi Anda (node Tailscale lain)
        # Atau melakukan curl ke API internal di jaringan Tailscale
        run: |
          echo "Node GitHub Actions kini terhubung sebagai node sementara."
          
          # Ganti 'nama-server-anda' dengan hostname node Tailscale yang ingin diakses
          # Contoh: Ping server database pribadi
          ping -c 3 nama-server-anda
          
          # Contoh: Deploy ke server melalui SSH/scp
          # ssh user@nama-server-anda "sudo systemctl restart aplikasi-anda"
          
          # Catatan: Jika Anda menggunakan ZeroTier atau NetBird, Anda akan
          # mengganti langkah 'tailscale/github-action' dengan tindakan
          # yang sesuai untuk otentikasi dan koneksi ZeroTier/NetBird.
          
      - name: Uji Coba Lanjutan (Opsional)
        # Di sini Anda bisa menempatkan langkah build atau unit testing Anda
        run: echo "Langkah CI/CD selesai."

      # =========================================================
      # Node akan otomatis terputus dan dihapus setelah job selesai
      # =========================================================
