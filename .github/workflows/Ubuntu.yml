name: Headless Go + Tailscale

on:
  workflow_dispatch:

jobs:
  setup:
    runs-on: ubuntu-22.04
    container:
      image: debian:12
      options: --user root

    timeout-minutes: 360

    env:
      USERNAME: "dolvin"
      PASSWORD: "whatsapp2"
      TALESCALE_AUTH_KEY: ${{ secrets.TALESCALE_AUTH_KEY }}

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Prepare System
        run: |
          apt update -y
          apt upgrade -y
          apt install -y git wget curl nano sudo

      - name: Create User (Optional)
        run: |
          useradd -m -s /bin/bash "$USERNAME" || true
          echo "$USERNAME:$PASSWORD" | chpasswd
          usermod -aG sudo "$USERNAME" || true

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh

      - name: Start Tailscale (Userspace Mode)
        run: |
          tailscaled --tun=userspace-networking --state=/tmp/tailscale.state &
          sleep 5
          tailscale up \
            --authkey="${TALESCALE_AUTH_KEY}" \
            --hostname=runner-${{ github.run_id }} \
            --tun=userspace-networking \
            --ssh \
            --accept-routes \
            --accept-dns
          tailscale ip -4

      - name: Keep Alive
        run: |
          echo "âœ… Connected via Tailscale"
          echo "Run 'tailscale status' to see the node"
          while true; do sleep 300; done
