name: setup-pentest-environment

on:
  workflow_dispatch:

jobs:
  setup-tools:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    env:
      # Jangan taruh password nyata di sini — set as repo secret (Settings → Secrets)
      DOLVIN_PASS: ${{ secrets.DOLVIN_PASS }}
      GO_VERSION: "1.21.11"   # ganti kalau mau versi lain

    steps:
      - name: Prepare runner
        run: |
          sudo apt-get update -y
          sudo apt-get upgrade -y
          # small swap so heavy builds won't OOM on runner
          if [ ! -f /swapfile ]; then
            sudo fallocate -l 4G /swapfile || sudo dd if=/dev/zero of=/swapfile bs=1M count=4096
            sudo chmod 600 /swapfile
            sudo mkswap /swapfile
            sudo swapon /swapfile
          fi
          sudo sysctl vm.swappiness=10
          free -h

      - name: Install base packages (apt)
        run: |
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
            build-essential git curl wget unzip ca-certificates gnupg lsb-release \
            net-tools iproute2 tcpdump nmap masscan netcat-openbsd socat jq \
            python3 python3-pip python3-venv python3-dev unzip zip \
            aircrack-ng iw rfkill macchanger \
            hashcat john hashcat-utils \
            sqlmap nikto \
            whois dnsutils
          
          # ensure pip & some python tools
          sudo -H python3 -m pip install --upgrade pip setuptools wheel
          sudo -H python3 -m pip install mitmproxy

      - name: Install Snap & snaps (optional GUI helpers)
        run: |
          sudo apt-get install -y snapd
          # note: some snaps may not be useful on CI runners, but included for convenience
          # sudo snap install --classic nmap || true

      - name: Install Go (manual) and setup env
        id: go_install
        run: |
          set -e
          GO_VER="${{ env.GO_VERSION }}"
          ARCH="linux-amd64"
          TGZ="go${GO_VER}.${ARCH}.tar.gz"
          curl -fsSL "https://golang.org/dl/${TGZ}" -o "/tmp/${TGZ}"
          sudo rm -rf /usr/local/go
          sudo tar -C /usr/local -xzf "/tmp/${TGZ}"
          # use a temporary GOPATH for the runner
          export GOPATH="/tmp/go"
          mkdir -p "${GOPATH}/bin"
          echo "GOPATH=${GOPATH}" >> $GITHUB_ENV
          echo "PATH=/usr/local/go/bin:${GOPATH}/bin:${PATH}" >> $GITHUB_ENV
          /usr/local/go/bin/go version

      - name: Install common Go-based tools
        env:
          PATH: /usr/local/go/bin:/tmp/go/bin:${{ env.PATH }}
          GOPATH: /tmp/go
        run: |
          set -e
          export PATH=/usr/local/go/bin:/tmp/go/bin:$PATH
          export GOPATH=/tmp/go
          go install github.com/OWASP/Amass/v3/...@latest
          go install github.com/projectdiscovery/subfinder/v2/cmd/subfinder@latest
          go install github.com/ffuf/ffuf@latest
          go install github.com/tomnomnom/httprobe@latest
          go install github.com/tomnomnom/gf@latest
          go install github.com/tomnomnom/assetfinder@latest
          go install github.com/projectdiscovery/nuclei/v2/cmd/nuclei@latest
          # copy go binaries to /usr/local/bin for convenience (ignore errors)
          sudo cp -v /tmp/go/bin/* /usr/local/bin/ || true

      - name: Install some community binaries (deb / tar)
        run: |
          set -e
          # gobuster (try apt first, fallback to tarball)
          sudo apt-get install -y gobuster || ( wget -qO- https://github.com/OJ/gobuster/releases/latest/download/gobuster-linux-amd64.tar.gz | sudo tar -xz -C /usr/local/bin gobuster )
          sudo -H python3 -m pip install wfuzz || true

      - name: Create user 'dolvin' (optional)
        if: env.DOLVIN_PASS != ''
        run: |
          sudo useradd -m -s /bin/bash dolvin || true
          echo "dolvin:${DOLVIN_PASS}" | sudo chpasswd
          sudo usermod -aG sudo dolvin || true
          id dolvin

      - name: Final healthcheck (versions + PATH)
        run: |
          echo "=== Versions ==="
          nmap --version | head -n1 || true
          masscan --version || true
          python3 --version
          go version || true
          echo "=== sample /usr/local/bin ==="
          ls -1 /usr/local/bin | sed -n '1,120p' || true
          echo "=== go bins (/tmp/go/bin) ==="
          ls -1 /tmp/go/bin || true

      - name: Save artifact (optional logs)
        uses: actions/upload-artifact@v4
        with:
          name: runner-info
          path: |
            /tmp
