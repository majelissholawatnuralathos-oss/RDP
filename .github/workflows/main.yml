name: install-go-snap-npm

on:
  workflow_dispatch:

jobs:
  install:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install prerequisites
        run: |
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends curl wget ca-certificates build-essential

      - name: Install snapd
        run: |
          sudo apt-get install -y snapd
          # enable/start snapd (may be noop on runners but try anyway)
          sudo systemctl enable --now snapd.socket || true
          # ensure core snap present
          sudo snap install core || true
          echo "snap installed:"
          snap version || true

      - name: Install Node.js (latest/current) and update npm to latest
        run: |
          # Install current Node.js (uses NodeSource current)
          curl -fsSL https://deb.nodesource.com/setup_current.x | sudo -E bash -
          sudo apt-get install -y nodejs
          # update npm to latest stable
          sudo npm install -g npm@latest
          echo "node $(node -v)"
          echo "npm  $(npm -v)"

      - name: Install latest Go (auto-detect latest stable)
        run: |
          set -euo pipefail
          GO_LATEST=$(curl -fsSL https://go.dev/VERSION?m=text)        # e.g. go1.21.11
          echo "Detected Go: $GO_LATEST"
          ARCH="linux-amd64"
          TGZ="${GO_LATEST}.${ARCH}.tar.gz"
          URL="https://golang.org/dl/${TGZ}"
          echo "Downloading $URL"
          curl -fsSL "$URL" -o "/tmp/${TGZ}"
          sudo rm -rf /usr/local/go
          sudo tar -C /usr/local -xzf "/tmp/${TGZ}"
          # setup GOPATH in a temp folder for runner
          export GOPATH="/tmp/go"
          mkdir -p "${GOPATH}/bin"
          echo "GOPATH=${GOPATH}" >> $GITHUB_ENV
          echo "PATH=/usr/local/go/bin:${GOPATH}/bin:${PATH}" >> $GITHUB_ENV
          /usr/local/go/bin/go version

      - name: Verify installations
        run: |
          echo "===== verification ====="
          if command -v go >/dev/null 2>&1; then go version; else echo "go: not found"; fi
          if command -v node >/dev/null 2>&1; then node -v; else echo "node: not found"; fi
          if command -v npm >/dev/null 2>&1; then npm -v; else echo "npm: not found"; fi
          snap version || true
          echo "GOPATH is: $GOPATH (note: exported to GITHUB_ENV for subsequent steps)"
